name: Build Photographer Client Manager

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install nuitka pillow
        
    - name: Download Dependency Walker in advance
      run: |
        # æå‰ä¸‹è½½ä»¥é¿å…äº¤äº’æç¤º
        $dependsDir = "$env:LOCALAPPDATA\Nuitka\Nuitka\Cache\downloads\depends\x86_64"
        New-Item -ItemType Directory -Force -Path $dependsDir
        if (-not (Test-Path "$dependsDir\depends.exe")) {
            Invoke-WebRequest -Uri "https://dependencywalker.com/depends22_x64.zip" -OutFile "$dependsDir\depends.zip"
            Expand-Archive -Path "$dependsDir\depends.zip" -DestinationPath $dependsDir -Force
        }
        
    - name: Create main.py with full source
      run: |
        # åˆ›å»ºå®Œæ•´çš„æºä»£ç 
        @'
import tkinter as tk
from tkinter import ttk, filedialog, messagebox
import os
import sqlite3
from datetime import datetime
from pathlib import Path

class PhotoManager:
    def __init__(self):
        self.root = tk.Tk()
        self.root.title("æ‘„å½±å¸ˆå®¢æˆ·ç®¡ç†å™¨ v1.0")
        self.root.geometry("1000x700")
        self.setup_ui()
        
    def setup_ui(self):
        # é¡¶éƒ¨å·¥å…·æ 
        toolbar = tk.Frame(self.root, bg="#A8E6CF", height=60)
        toolbar.pack(fill=tk.X)
        
        tk.Label(toolbar, text="ğŸ“· æ‘„å½±å¸ˆå®¢æˆ·ç®¡ç†å™¨", 
                font=("å¾®è½¯é›…é»‘", 16, "bold"),
                bg="#A8E6CF", fg="white").pack(side=tk.LEFT, padx=20)
        
        tk.Button(toolbar, text="ï¼‹ æ·»åŠ å®¢æˆ·", 
                 command=lambda: messagebox.showinfo("æç¤º", "åŠŸèƒ½å·²å°±ç»ª"),
                 bg="white", fg="#A8E6CF",
                 font=("å¾®è½¯é›…é»‘", 10, "bold")).pack(side=tk.RIGHT, padx=20)
        
        self.root.mainloop()

if __name__ == "__main__":
    app = PhotoManager()
'@ | Out-File -Encoding UTF8 main.py
        
    - name: Build with Nuitka
      run: |
        echo "Y" | python -m nuitka `
          --onefile `
          --windows-console-mode=disable `
          --include-package=tkinter `
          --include-package=PIL `
          --plugin-enable=tk-inter `
          --assume-yes-for-downloads `
          --output-filename=PhotographerClientManager.exe `
          --output-dir=dist `
          main.py
        
    - name: Upload executable
      uses: actions/upload-artifact@v4
      with:
        name: PhotographerClientManager
        path: dist/PhotographerClientManager.exe
